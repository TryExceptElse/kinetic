group 'com.github.io.tryexceptelse'
version '0.0.1'

apply plugin: 'cpp'

buildscript {
    ext.third_party_dir = 'build/third_party'
    ext.test_dir = '../out/test/actor'
}

model {
    components {
        actor(NativeLibrarySpec) {
            sources {
                cpp {
                    source {
                        srcDirs "src", "third_party/src"
                    }
                    exportedHeaders {
                        srcDirs "src", "third_party/src"
                    }
                }
            }
            binaries.all {
                if (debug == 1) {
                    cppCompiler.args '-O1', '-g'
                } else {
                    cppCompiler.args '-O3'
                }
            }
            binaries.withType(SharedLibraryBinary) { binary ->
                buildable = false
            }
        }
        testActor(NativeExecutableSpec) {
            sources {
                cpp {
                    source {
                        srcDirs "test", 'third_party/test'
                    }
                }
            }
            binaries.all {
                lib library: 'actor', linkage: 'static'
                cppCompiler.args '-O1', '-g'
            }
        }
    }
}

build.doLast {
    cppLint
    // copy built tests
    copy {
        includeEmptyDirs = false
        from new File("build/exe/testActor")
        into test_dir
    }
}

task cppLint(type:Exec) {
    workingDir 'src'
    commandLine 'python3'
    args  '-m', 'cpplint', '--recursive', '--quiet', '.'
}


task cleanTestDir(type: Delete) {
}

clean.doLast {
    cleanTestDir
}
